<?php

## Die POST Variablen muessen gesetzt sein, damit die ilAuthFactory Klasse die Authentifizierung gegen ILIAS macht.
## Zum debuggen im Browser, habe ich diese beiden Zeilen hinzugefuegt.
$_POST['username'] = $_REQUEST['user'];
$_POST['password'] = $_REQUEST['pass'];

include_once 'Services/Authentication/classes/class.ilAuthFactory.php';
ilAuthFactory::setContext(ilAuthFactory::CONTEXT_SOAP);

require_once("Services/Init/classes/class.ilInitialisation.php");
$ilInit = new ilInitialisation();
$ilInit->initILIAS('webdav');

#$login=$ilUser->getLogin();

# Stuff
require_once('classes/class.ilObjectFactory.php');
require_once('Modules/Exercise/classes/class.ilObjExerciseAccess.php');
require_once('Modules/Exercise/classes/class.ilObjExerciseGUI.php');
require_once('Modules/Exercise/classes/class.ilExAssignment.php');


#function printCurrentDesk($ilUser) {
#}
  ## Header auf XML stellen
  header ("Content-Type:text/xml");  
  
  #$login=$ilUser->getLogin();
  
  ## MAIN XML TAG (auch XML Root genannt)
  $xml = new SimpleXMLElement("<Iliconnect/>");

  ## XML ILICONNECT CURRENT
  $current = $xml->addChild("Current");

  ## XML ILICONNECT CURRENT NOTIFICATIONS
  $notifications = $current->addChild("Notifications");

  ## XML ILICONNECT CURRENT DESKTOP
  $desktop = $current->addChild("Desktop");

  ## PERSOENLICHER SCHREIBTISCH AUSGEBEN
  $desktop_items = $ilUser->getDesktopItems();
  
  ## Tree ist eine ILIAS eigene Variable
  #global $tree;

  ## In $desktop_items sind nun ILIAS Objekte.
  foreach($desktop_items as $item) {
    desktopItem2Xml($item,$desktop,$notifications);
  }
  
  ## AUSGABE DER XML STRUKTUR
  $xml->asXML();
#}


## Der (un)uebersichtlichkeit halber in eine eigene funktion gepackt.
## erzeugt einen eintrag innerhalb des NOTIFICATIONS tag
function notification2Xml($a,$nxml)
{
#$ass_data = ilExAssignment::getAssignmentDataOfExercise(60);

#print_r($ass_data);
#    foreach ($ass_data as $ass)
#    {
#    print_r($ass);
#    }

  #print_r($a);
  
#  $factory=new ilObjectFactory();
#  $esc=$factory->getInstanceByRefId($a['ref_id']);
  #print_r($esc->getTimestamp());
  
#  print_r($esc);
#  die();
#   
#  $ass = new ilExAssignment($a["ref_id"]);
#  $ass->setExerciseId($a["ref_id"]);
#  $ass->read();
  
  #print_r($ass->getDeadline());
#die();
#  $assarray = $n->getDeadline();
  #print_r($n);
  
  #print_r($n);
  $notify = $nxml->addChild("Notification");
  $notify->addChild("title",$a["title"]);
  #$notify->addChild("date",$assarray->getDeadline());
  $notify->addChild("ref_id",$a["ref_id"]);
  $notify->addChild("description",$a["description"]);
}


## FUNCTION FUER DIE REKURSIVE ABARBEITUNG DER CHILD ITEMS
function desktopItem2Xml($array,$sxml,$notifications){
  if(strstr("file|fold|crs|tst|exc",$array["type"]))
  {
    $item = $sxml->addChild("Item");
    $item->addChild("title",$array[title]);
    $item->addChild("description",$array[description]);
    $item->addChild("type",$array[type]);
    $item->addChild("ref_id",$array[ref_id]);

    if($array[type] == "exc")
    {
      notification2Xml($array,$notifications);
    }
    
    global $tree;
    $children=$tree->getChilds($array[ref_id]);
    foreach($children as $child)
    {
      desktopItem2Xml($child,$item,$notifications);
    }
  } else {
    # Debugging
    #print_r($array);
  }
}


switch($_GET["action"]) {
  case "sync":
    #printCurrentDesk($ilUser);
    break;
  case "magazin":
    #printMagazin();
    break;
  case "search":
    #suche
    break;
  default:
    echo "ACTION_UNKNOWN";
    break;
}

?>
